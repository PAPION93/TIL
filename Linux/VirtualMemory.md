# Virtual Memory
> Topdown 방식의 지속 업데이트 예정.  
> 최초 2020-01-03  
> 추가 2020-01-05  
> 참고 [What does swappiness do and how does it affect swap_tendency?](https://access.redhat.com/solutions/103833)


## 개요
> 메모리의 물리적 한계를 극복하기 위해 HDD 또는 SSD의 일부를 마치 메모리처럼 사용하는 기술.  
> 기본적으로 하나의 프로그램이 실행될 때, 프로그램 전체메모리가 올라와 실행되지 않고 필요한 부분만을 불러와 실행하는 기법을 기본으로 한다.  
> 리눅스에서는 메모리가 부족할 경우 또는 지나치게 많은 요구에 의해 오염될 경우, 프로그램의 논리와 무관하게 오류가 난다. 이를 방지하기 위한 기술이 가상메모리이고 그 영역을 스왑 영역이라고 한다.  

## 스왑이 발생하는 시기
`swap_tendency = mapped_ratio / 2 + distress + swappiness`
- 리눅스는 이와 같이 `swap_tendency`를 계산하는데, `swap_tendency` 값이 100을 초과하면 스왑을 시작한다.
- `distress` 값이 낮고 `swappiness` 값을 60으로 설정했다면, 시스템 내 총 메모리의 80%가 할당될때 까지 스왑은 발생하지 않는다. 앱의 메모리가 스왑 아웃되는 것을 보고 싶지 않다면 `swappiness`를 5또는 10같이 낮게 설정할 수 있으며, 커널은 `distress` 값이 상당히 높을 때 까지 프로세스 메모리를 무시하게 된다.
- `mapped_ratio` 와 `distress` 는 사용자가 수정할 수 없다.

#### 1. mapped_ratio
- 현재 사용 중인 메모리 사용률

#### 2. distress
- 메모리 페이지 확보가 얼마나 어려운 상태인지 나타내는 지표로서 0~100 값을 지닌다.
- 리눅스커널은 페이지회수를 위해 적은 수의 페이지부터 회수시도를 하는데 실패할수록 점점 더 많은 페이지 수를 회수 시도한다.
- 최초 0, 하지만 메모리 확보를 실패한다면 최종적으로 100까지 증가한다.

#### 3. swappiness
- 스왑메모리 사용을 제어하기 위한 커널 파라미터, default 는 60 이다
- `/etc/sysctl.conf`의 `vm.swappiness` 에 값을 지정하여 수정할 수 있으며, 튜닝시에는 작은 단위로 변경이 이루어져야 한다.
- 이 값이 높을수록 스왑공간을 더 많이 사용하게 되어 캐시를 위해 더 많은 메모리를 남겨두지만, 줄일수록 시스템이 스왑을 덜 사용하게되고 앱의 응답성이 향상된다.
- 이를 0으로 설정하면 `distress`의 값이 100이 되어야 스왑을 사용하게 된다.

## Swap Memory를 사용중인 프로세스 확인하기
1. `top`
2. `f`를 입력하면 `Current Fields` 가 나오는데 `p`를 입력하면 `SWAP` 앞에 `*`이 추가된다.
3. `Enter`를 입력하고 나오면 COMMAND 앞에 SWAP이 출력된다.(`>`나 `<`를 통해 정렬)